# MySQL 엔진의 잠금

MySQL에서 사용하는 잠금은 크게 아래 2가지로 나뉜다.   
   
1. 스토리지 엔진 레벨   
2. MySQL 엔진 레벨  

MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치지만,  
스토리지 엔진 레벨의 잠금은 스토리지 엔진간 상호 영향을 미치지는 않는다.  
  
MySQL 엔진에서는   
테이블 데이터 동기화를 위한 테이블 락,    
테이블의 구조를 잠그는 메타데이터 락,  
사용자의 필요에 맞게 사용할 수 있는 네임드 락 등등이 있다.    

## 글로벌 락 

글로벌 락은 `FLUSH WITH READ LOCK` 명령으로 획득할 수 있다.        
MySQL에서 제공하는 잠금 가운데 가장 범위가 크다.     

일단 한 세션에서 글로벌 락을 획득하면  
다른 세션에서 SELECT를 제외한 대부분의 DDL 문장이나 DML 문장을 실행하는 경우    
글로벌 락이 해제될 때까지 해당 문장이 대기 상태로 남는다.    
    
글로벌 락이 영향을 미치는 범위는 MySQL 서버 전체이며        
작업 대상 테이블이나 데이터베이스가 다르더라도 동일하게 영향을 미친다.       
여러 데이터베이스에 존재하는 MyISAM 이나 Memory 테이블에 대해       
mysqldump 로 일관된 백업을 받아야할 때는 글로벌 락을 사용한다.     

```
글로벌 락을 거는 FLUSH TABLES READ LOCK 명령은 실행과 동시에 MySQL 서버에 존재하는 모든 테이블을 닫고 잠금을 건다.  
FLUSH TABLES READ LOCK 명령이 실행되기 전에 테이블이나 레코드에 쓰기 잠금을 거는 SQL 이 실행되었다면  
이 명령은 해당 테이블의 읽기 잠금을 걸기 위해 먼저 실행된 SQL과 그 트랜잭션이 완료될때까지 기다려야한다.  

FLUSH TABLES READ LOCK 명령은 테이블에 읽기 잠금을 걸기 전에 먼저 테이블을 플러시 해야하기 때문에  
테이블에 실행중인 모든 종류의 쿼리가 완료되어야 한다.   
그래서 장시간 SELECT 쿼리가 실행되고 있을 때는 FLUSH TABLES READ LOCK 명령은 SELECT 쿼리가 종료될때까지 기다려야한다.     
  
만약 같이 사용하게 된다면, 최악의 케이스로 MySQL 서버의 모든 테이블에 대한 CRUD 쿼리가 아주 오랜 시간동안 실행되지 못할 수 있다.     
글로벌락은 영향을 미치는 범위가 크므로 운영에 사용하기는 가급적 삼가하는 것이 좋다.     
또한 mysqldump 같은 백업 프로그램은 우리가 알지 못하는 사이에 이 명령을 내부적으로 실행하고 백업할 수 있다.     
mysqldump 를 이용해 백업을 수행한다면 mysqldump 에서 사용하는 옵션에 따라 MySQL 서버에 어떤 잠금을 걸게 되는지 확인도 좋다.  
```
  
글로벌락은 MySQL 서버의 모든 변경 작업을 멈춘다.      
하지만, 기존 MySQL 엔진이 Memory 스토리지인 MyISAM 에서 InnoDB 로 스토리지 엔진이 변경되면서   
일관된 데이터 상태를 위해 모든 데이터 변경 작업을 멈출 필요성은 없어 졌다     
그래서 8.0 부터는 xtrabackup 이나 Enterprise Backup과 같은 백업 툴들의 안정적인 실행을 위해 백업락이 도입되었다.   
 
## 테이블 락   
테이블 락은 개별 테이블 단위로 설정되는 잠금이며,          
명시적 또는 묵시적으로 특정 테이블의 락을 획득할 수 있다.       

**명시적인 락**   
* 명시적인 락 획득 방법 : `LOCK TABLES 테이블이름 [ READ or WRITE ]` 
* 명시적인 락 반환 방법 : `LOCK TABLES 테이블이름`
* 특별한 상황이 아니라면 애플리케이션 단에서 사용할 일은 적다.  

**묵시적 락**  
* MyISAM 이나 MEMORY 테이블에 데이터를 변경하는 쿼리를 실행하면 발생한다.   
* MySQL 서버가 데이터가 변경되는 테이블에 잠금을 설정하고 데이터를 변경한 후, 즉시 잠금을 해제한다.   
* 즉, 쿼리가 실행되는 동안 자동으로 획득했다가 쿼리 완료 후 자동으로 해제된다.   
* InnoDB 테이블의 경우, 스토리지 엔진 차원에서 레코드 기반의 잠금을 제공하기 때문에     
  단순 데이터 변경 쿼리로 인해 묵시적인 테이블락이 설정되지는 않는다.     
* 보다 정확히 말하면, InnoDB 테이블에도 테이블 락이 설정되지만 대부분의 DML 에는 무시되고 DDL에는 영향을 미친다.  

## 네임드 락 
 
네임드 락(Named Lock)은 `GET_LOCK()` 함수를 이용해서 임의의 문자열에 대한 잠금을 설정할 수 있다.   
잠금의 특징은 대상이 `테이블`이나 `레코드` 또는 AUTO_INCREMENT 와 같은 DB 객체가 아니라는 것이다.   
